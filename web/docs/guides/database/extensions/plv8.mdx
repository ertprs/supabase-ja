---
id: plv8
title: "plv8；Javascript言語"
description: Javascript language for PostgreSQL.
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

`plv8`拡張は、Postgres内でJavascriptを使用できるようにします。

## 概要

PostgresはネイティブでSQLを実行しますが、他の「手続き型言語」も実行できます。`plv8`はJavascriptのコード、特に[V8 Javascriptエンジン](https://v8.dev)上で実行されるコードを実行できます。

これは、データベース関数、トリガ、クエリなどに使用できます。

## 使用方法


### 有効化

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

```sh
1. Go to the Database page.
2. Click on "Extensions" in the sidebar.
3. Search for "plv8".
4. Click the toggle.
```

</TabItem>
<TabItem value="SQL">

```sql 

-- Example: enable the "plv8" extension 
create extension plv8;

-- Example: disable the "plv8" extension 
drop extension if exists plv8;

```

SQLコードが`拡張機能を作成し`ていても、これは「拡張機能を有効にする」ことと同じです。
拡張機能を無効にするには、`drop extension`を呼び出します。

手続き型言語は`pg_catalog`に自動的にインストールされますので、スキーマを指定する必要はありません。

</TabItem>
</Tabs>

### `plv8`関数の作成

`plv8`で書かれた関数は、他のPostgreSQL関数と同じように書かれますが、`言語`識別子は`plv8`に設定されています。

```sql
create or replace function function_name() 
returns void as $$
    // V8 Javascript
    // code
    // here
$$ language plv8;
```

他のPostgres関数と同様に`plv8`関数を呼びだすことができます。



<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
]}>
<TabItem value="SQL">


```sql
select function_name();
```

</TabItem>
<TabItem value="JS">

```js 

const { data, error } = supabase.rpc('function_name')

```

</TabItem>
</Tabs>

## 例

### スカラー関数

[スカラー関数](https://plv8.github.io/#scalar-function-calls)とは、ユーザーの入力を受け取り、1つの結果を返すものです。

```sql
create or replace function hello_world(name text) 
returns text as $$

    let output = `Hello, ${name}!`;
    return output;

$$ language plv8;
```

### SQLの実行

[`plv8.execute`](https://plv8.github.io/#plv8-execute)関数を使って、`plv8`のコード内でSQLを実行できます。

```sql
create or replace function update_user(id bigint, first_name text) 
returns smallint as $$

    var num_affected = plv8.execute(
        'update profiles set first_name = $1 where id = $2', 
        [first_name, id]
    );

    return num_affected;
$$ language plv8;
```

### セットリターン関数

[セット](https://plv8.github.io/#set-returning-function-calls)リターン関数とは、テーブルの行のように結果のフルセットを返す関数です。

```sql
create or replace function get_messages() 
returns setof messages as $$

    var json_result = plv8.execute(
        'select * from messages'
    );

    return json_result;
$$ language plv8;
```


## リソース

- [`plv8`](https://plv8.github.io/)の公式[ドキュメント](https://plv8.github.io/)です。
- [plv8のGithubリポジトリ](https://github.com/plv8/plv8)。
