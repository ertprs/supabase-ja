---
id: full-text-search
title: "全文検索"
description: How to use full text search in PostgreSQL.
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


Postgresには、`全文検索`クエリを処理する関数が組み込まれています。これは、Postgres内の「検索エンジン」のようなものです。


## 準備

このガイドでは、以下の例のデータを使用します。

<!-- textlint-disable -->

<Tabs
defaultValue="Data"
values={[
  {label: 'Data', value: 'Data'},
  {label: 'SQL', value: 'SQL'},
]}>

<TabItem value="SQL">

<!-- textlint-enable -->

```sql
create table books (
  id serial primary key,
  title text,
  author text,
  description text
);

insert into books (title, author, description) 
values 
  ('The Poky Little Puppy','Janette Sebring Lowrey','Puppy is slower than other, bigger animals.'),
  ('The Tale of Peter Rabbit','Beatrix Potter','Rabbit eats some vegetables.'),
  ('Tootle','Gertrude Crampton','Little toy train has big dreams.'),
  ('Green Eggs and Ham','Dr. Seuss','Sam has changing food preferences and eats unusually colored food.'),
  ('Harry Potter and the Goblet of Fire','J.K. Rowling','Fourth year of school starts, big drama ensues.');
```

</TabItem>
<TabItem value="Data">

| id    | title | author | description |
| ----  | ---- | ---- | ----------- |
|    1 | The Poky Little Puppy | Janette Sebring Lowrey | Puppy is slower than other, bigger animals. |
|    2 | The Tale of Peter Rabbit  | Beatrix Potter | Rabbit eats some vegetables. |
|    3 | Tootle | Gertrude Crampton | Little toy train has big dreams. |
|    4 | Green Eggs and Ham | Dr. Seuss | Sam has changing food preferences and eats unusually colored food. |
|    5 | Harry Potter and the Goblet of Fire | J.K. Rowling | Fourth year of school starts, big drama ensues.  |

</TabItem>

</Tabs>

## 使用方法

このガイドで取り上げる関数になります。

### `to_tsvector()`

データを検索可能な "トークン "に変換します。`to_tsvector()`は "to text search vector "の略です。例えば、以下のようなものです。

```sql
select to_tsvector("green eggs and ham")

-- Returns 'egg':2 'green':1 'ham':4
``` 

これらのトークンをまとめて "ドキュメント"と呼び、Postgresはこれを比較に使用できます。

### `to_tsquery()`

`to_tsquery()`は "to text search query "の略で、クエリ文字列をマッチする "トークン "に変換します。

例えば、ユーザーが"eggs"を検索して、カラムに "egg"という値があったとしても、おそらくマッチしたものを返したくなります。


### マッチ`@@`

`@@`記号は、全文検索の「マッチ」記号です。この記号は、`to_tsvector`の結果と`to_tsquery`の結果の間で一致するものを返します。

次の例を見てみましょう。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select * 
from books 
where name = 'Harry';
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .eq('name', 'Harry')
```

</TabItem>
  
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .eq('name', 'Harry')
  .execute();
```

</TabItem>
</Tabs>


上の等号`(=)`は、マッチするものに対して非常に「厳密」です。フルテキスト検索では、「ハリー・ポッター」の本をすべて見つけたい場合がありますので、上記の例を書き換えることができます。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select * 
from books 
where to_tsvector(name) @@ to_tsquery('Harry');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('name', `'Harry'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('name', "'Harry'")
  .execute();
```

</TabItem>
</Tabs>

## 基本的なフルテキストクエリ

### 1つの列を検索する

`説明文`に「`big`」という単語が含まれる`書籍`をすべて検索するには次の通りです。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  * 
from 
  books
where 
  to_tsvector(description) 
  @@ to_tsquery('big');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'big'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'big'")
  .execute();
```

</TabItem>
<TabItem value="Data">

| id | title                               | author            | description                                     |
| -- | ----------------------------------- | ----------------- | ----------------------------------------------- |
| 3  | Tootle                              | Gertrude Crampton | Little toy train has big dreams.                     |
| 5  | Harry Potter and the Goblet of Fire | J.K. Rowling      | Fourth year of school starts, big drama ensues. |

</TabItem>
</Tabs>

### 複数のコラムを検索する

`説明文`または`タイトル`に「`little`」という単語が含まれるすべての`書籍`を検索します。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  * 
from 
  books
where 
  to_tsvector(description || ' ' || title) -- concat columns, but be sure to include a space to separate them!
  @@ to_tsquery('little');
```

</TabItem>
<TabItem value="Data">

| id | title                 | author                 | description                                 |
| -- | --------------------- | ---------------------- | ------------------------------------------- |
| 1  | The Poky Little Puppy | Janette Sebring Lowrey | Puppy is slower than other, bigger animals. |
| 3  | Tootle                | Gertrude Crampton      | Little toy train has big dreams.            |

</TabItem>
</Tabs>

### すべての検索ワードに一致する

`説明文`に`little`と`big`の両方の単語が含まれている`書籍`をすべて検索するには、`&`記号を使用します。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  * 
from 
  books
where 
  to_tsvector(description)
  @@ to_tsquery('little & big'); -- use & for AND in the search query
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'little' & 'big'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'little' & 'big'")
  .execute();
```

</TabItem>
<TabItem value="Data">

| id | title  | author            | description                      |
| -- | ------ | ----------------- | -------------------------------- |
| 3  | Tootle | Gertrude Crampton | Little toy train has big dreams. |

</TabItem>
</Tabs>

### 任意の検索語にマッチ

`説明文`に`little`または`big`のいずれかの単語が含まれている`書籍`をすべて検索するには、`｜`記号を使用します。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  * 
from 
  books
where 
  to_tsvector(description) 
  @@ to_tsquery('little | big'); -- use | for OR in the search query
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'little' | 'big'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'little' | 'big'")
  .execute();
```

</TabItem>
<TabItem value="Data">

| id | title                 | author                 | description                                 |
| -- | --------------------- | ---------------------- | ------------------------------------------- |
| 1  | The Poky Little Puppy | Janette Sebring Lowrey | Puppy is slower than other, bigger animals. |
| 3  | Tootle                | Gertrude Crampton      | Little toy train has big dreams.            |

</TabItem>
</Tabs>

`big`を検索すると、`bigger`（または`bigest`など）という単語を含む結果が表示されることに注目してください。

## インデックスの作成

さて、フルテキスト検索が動作するようになったので、`インデックス`を作成してみましょう。これにより、Postgresが事前に文書を「構築」でき、クエリの実行時に文書を作成する必要がなくなります。これにより、クエリの実行がより速くなります。

### 検索可能な列

`タイトル`と`説明の`列の検索可能なインデックスを格納するために、`books`テーブルの中に新しい列`fts`を作成しましょう。

Postgresの特別な機能である[「生成された列](https://www.postgresql.org/docs/current/ddl-generated-columns.html)」を使用して、`タイトル`と`説明の`列の値が変更されるたびにインデックスが更新されるようにします。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
alter table 
  books 
add column 
  fts tsvector generated always as (to_tsvector('english', description || ' ' || title)) stored;
  
create index books_fts on books using gin (fts); -- generate the index

select id, fts 
from books;
```

</TabItem>
<TabItem value="Data">

| id | fts                                                                                                             |
| -- | --------------------------------------------------------------------------------------------------------------- |
| 1  | 'anim':7 'bigger':6 'littl':10 'poki':9 'puppi':1,11 'slower':3                                                 |
| 2  | 'eat':2 'peter':8 'rabbit':1,9 'tale':6 'veget':4                                                               |
| 3  | 'big':5 'dream':6 'littl':1 'tootl':7 'toy':2 'train':3                                                         |
| 4  | 'chang':3 'color':9 'eat':7 'egg':12 'food':4,10 'green':11 'ham':14 'prefer':5 'sam':1 'unus':8                |
| 5  | 'big':6 'drama':7 'ensu':8 'fire':15 'fourth':1 'goblet':13 'harri':9 'potter':10 'school':4 'start':5 'year':2 |

</TabItem>
</Tabs>

### 新しいカラムを使った検索

インデックスを作成して入力したので、これまでと同じ手法で検索してみましょう。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
  {label: 'Data', value: 'Data'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  * 
from 
  books
where 
  fts @@ to_tsquery('little & big');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('fts', `'little' & 'big'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('fts', "'little' & 'big'")
  .execute();
```

</TabItem>
<TabItem value="Data">

| id | title  | author            | description                      | fts                                                     |
| -- | ------ | ----------------- | -------------------------------- | ------------------------------------------------------- |
| 3  | Tootle | Gertrude Crampton | Little toy train has big dreams. | 'big':5 'dream':6 'littl':1 'tootl':7 'toy':2 'train':3 |

</TabItem>
</Tabs>

## クエリ演算子

[PostgreSQL](https://www.postgresql.org/docs/current/functions-textsearch.html)をご覧ください。「[テキスト検索関数と演算子](https://www.postgresql.org/docs/current/functions-textsearch.html)」を参照してください。ここでは、より高度な`フルテキスト`検索に使用できる、以下のような追加の問い合わせ演算子について説明します。

### 近接記号`：<->`

例えば、"big"にマッチした後、"dreams"にマッチした"`big dreams`"というフレーズを検索する場合に使用します。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
]}>
<TabItem value="SQL">

<!-- textlint-disable -->

```sql
select 
  *
from 
  books
where 
  to_tsvector(description) @@ to_tsquery('big <-> dreams');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'big' <-> 'dreams'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'big' <-> 'dreams'")
  .execute();
```

</TabItem>
</Tabs>


`<->`を使って、一定の距離内にある単語を探すこともできます。例えば、`「year」`と`「school」`を2語以内で検索するには、次のようにします。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
]}>
<TabItem value="SQL">

<!-- textlint-disable -->

```sql
select 
  *
from 
  books
where 
  to_tsvector(description) @@ to_tsquery('year <2> school');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'year' <2> 'school'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'year' <2> 'school'")
  .execute();
```

</TabItem>
</Tabs>


### 否定`： !`

否定記号は、検索語を含ま_ない_フレーズを見つけるために使用できます。例えば、`big`という単語を含み、`little`という単語を含まないレコードを見つけるには次の通りになります。

<!-- textlint-disable -->

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'Javascript', value: 'JS'},
  {label: 'Dart', value: 'DART'},
]}>
<TabItem value="SQL">

<!-- textlint-enable -->

```sql
select 
  *
from 
  books
where 
  to_tsvector(description) @@ to_tsquery('big & !little');
```

</TabItem>
<TabItem value="JS">

```js
const { data, error } = await supabase
  .from('books')
  .select()
  .textSearch('description', `'big' & !'little'`)
```

</TabItem>
<TabItem value="DART">

```dart
final result = await client
  .from('books')
  .select()
  .textSearch('description', "'big' & !'little'")
  .execute();
```

</TabItem>
</Tabs>


## リソース

* [PostgreSQL。テキスト検索関数と演算子](https://www.postgresql.org/docs/12/functions-textsearch.html)



