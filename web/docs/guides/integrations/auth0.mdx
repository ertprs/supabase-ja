---
id: auth0
title: 'Auth0'
description: 'Swap out Supabase authentication with Auth0. Let Auth0 handle tokens and signing users in and out, while Supabase enforces authorization policies with Row Level Security (RLS).'
---

このガイドでは、Auth0とSupabaseを使ってNext.jsのアプリケーションを構築する手順を説明します。Auth0でユーザーの認証とトークンの管理をし、Supabaseで行単位セキュリティーポリシーを使った認可ロジックを記述します。

> 注：このガイドは、[Auth0のブログ](https://auth0.com/blog/)に掲載されている[Using Next.js and Auth0 with Supabase](https://auth0.com/blog/using-nextjs-and-auth0-with-supabase/)の記事を参考にしています。Auth0とSupabaseの統合に関する実践的なステップバイステップのガイドをご覧ください。

このガイドの完全なコード例は[こちら](https://github.com/dijonmusters/supabase-auth0-example)にあります。

[Auth](https://auth0.com/)0は、認証・認可プラットフォームであり、ユーザーを認証・管理するための様々な戦略を提供します。ユーザーがアプリケーションにサインインする方法、生成されるトークン、ユーザーに関するデータの保存などを細かく制御できます。

[Next.js](https://nextjs.org/)は、Reactの上に構築されたWebアプリケーションフレームワークです。Next.jsは、Reactの上に構築されたWebアプリケーションフレームワークです。この例では、アプリケーション内にサーバーサイドのロジックを書くことができるため、Next.jsを使用します。Auth0は、Next.js専用に[非常によく統合された認証ライブラリ](https://www.npmjs.com/package/@auth0/nextjs-auth0)を書いています。

> 注：Next.jsのAPIルート（サーバーレス関数）は、Express、Koa、FastifyなどのNodeサーバーフレームワークの構造によく似ています。このガイドで紹介するサーバーサイドのロジックは、これらのフレームワークで簡単にリファクタリングでき、フロントエンドとは別のアプリケーションとして管理できます。

Auth0のアカウントをお持ちでない方は、[こちらで](https://auth0.com/signup)アカウントを作成してください。

また、Supabaseのアカウントも必要で、[こちら](https://app.supabase.io/)からサインインして作成できます。

## ステップ1：Auth0のテナントの作成

Auth0のダッシュボードから、Auth0のロゴの右にあるメニューをクリックして、`Create tenant`を選択します。

![Create tenant from Auth0 dashboard](/img/guides/integrations/auth0/IYzHxeW.png)

テナントの`ドメイン`を入力してください - これは一意である必要があります。

`地域`を選択してください - ユーザーの大半に地理的に近い地域を選択してください。

`環境タグ`に`Development`を選択します。本番稼動の準備ができた時点で本番稼動とします。

![Auth0 tenant settings](/img/guides/integrations/auth0/iSA3E0J.png)

## ステップ2：Auth0アプリケーションの設定

サイドバーメニューから`Applications`→`Applications`を選択し、`Create Application`をクリックします。

アプリケーションに名前を付け、`Regular Web Applications`を選択し、`Create`をクリックします。

![Auth0 application settings](/img/guides/integrations/auth0/ANU4Wez.png)

`Settings」`を選択し、「`Application URIs`」セクションに移動して、以下を更新します。

`許可されるコールバックURL` `： http://localhost:3000/api/auth/callback`

許可される`ログアウト`URL`： http://localhost:3000`

`設定」`セクションの一番下までスクロールし、`「詳細設定」`を表示します。

`OAuth`を選択し、`JSON Web Token Signature`を`RS256`に設定します。

`OIDC Conformant`が`Enabled`になっていることを確認します。

`Save`をクリックして設定を更新します。

## ステップ3： Supabaseプロジェクトの作成

[Supabase ダッシュボード](https://app.supabase.io/)から、`New project` をクリックします。

Supabaseプロジェクトの`名前`を入力します。

安全な`データベースパスワード`を入力します。

Auth0テナントで選択したのと同じ`地域`を選択します。

`Create new project` をクリックします。

![New Supabase project settings](/img/guides/integrations/auth0/qnmJEU7.png)

## ステップ 4: Supabase でデータを作成する

[Supabase ダッシュボード](https://app.supabase.io/)のサイドバーメニューから、`Table editor`、`New table`の順にクリックします。

`名前`欄に`todo`と入力します。

`RLS（Row Level Security）を有効にする`］を選択します。

2つの新しい列を作成します。

- `タイトル`(`テキスト`)
- `user_id`(`テキスト`)
- `is_complete`-`bool`（デフォルト値は`false`）

`保存」`をクリックして、新しいテーブルを作成します。

![Todo table](/img/guides/integrations/auth0/33kqP4K.png)

`テーブルエディタービュー`で`Todo`テーブルを選択し、`［行の挿入］`をクリックします。

`タイトル`フィールドを入力し、`「保存」`をクリックします。

![New row settings](/img/guides/integrations/auth0/mEhHAWC.png)

行の`挿入」`をクリックして、いくつかのTodoを追加します。

![List of todos](/img/guides/integrations/auth0/dLOvhdq.png)

## ステップ5：Next.jsアプリの構築

新しいNext.jsプロジェクトを作成します。

```bash
npx create-next-app <name-of-project>
```

`.env.local`ファイルを作成し、以下の値を入力します。

```
AUTH0_SECRET=any-secure-value
AUTH0_BASE_URL=http://localhost:3000
AUTH0_ISSUER_BASE_URL=https://<name-of-your-tenant>.<region-you-selected>.auth0.com
AUTH0_CLIENT_ID=get-from-auth0-dashboard
AUTH0_CLIENT_SECRET=get-from-auth0-dashboard
NEXT_PUBLIC_SUPABASE_URL=get-from-supabase-dashboard
NEXT_PUBLIC_SUPABASE_KEY=get-from-supabase-dashboard
SUPABASE_SIGNING_SECRET=get-from-supabase-dashboard
```

> 注：Auth0の値は、`「設定」→「`アプリケーションの`基本情報`」で確認できます。

![Auth0 settings](/img/guides/integrations/auth0/o07FaoV.png)

> 注：Supabaseの値は、プロジェクトの`「Settings」>「API」`で確認できます。

![Supabase settings](/img/guides/integrations/auth0/r1GAfLo.png)

Next.js開発サーバーを再起動すると、`.env.local`から新しい値が読み込まれます。

```bash
npm run dev
```

## ステップ5: Auth0 Next.jsライブラリのインストール

`@auth0/nextjs-auth0`ライブラリをインストールします。

```bash
npm i @auth0/nextjs-auth0
```

新しいファイル`pages/api/auth/[...auth0].js`を作成し、追加します。

```jsx
// pages/api/auth/[...auth0].js

import { handleAuth } from '@auth0/nextjs-auth0'

export default handleAuth()
```

> 注：これにより、いくつかのAPIルートが作成されます。主に使用するのは、`/api/auth/login`と`/api/auth/logout`で、ユーザーのログインとログアウトを処理します。

`pages/_app.js`を開き、Auth0の`UserProvider`で`Component`をラップします。

```jsx
// pages/_app.js

import React from 'react'
import { UserProvider } from '@auth0/nextjs-auth0'

const App = ({ Component, pageProps }) => {
  return (
    <UserProvider>
      <Component {...pageProps} />
    </UserProvider>
  )
}

export default App
```

`pages/index.js`を更新して、ユーザーがランディングページを見るためにログインしていることを確認します。

```jsx
// pages/index.js

import styles from '../styles/Home.module.css'
import { withPageAuthRequired } from '@auth0/nextjs-auth0'
import Link from 'next/link'

const Index = ({ user }) => {
  return (
    <div className={styles.container}>
      <p>
        Welcome {user.name}!{' '}
        <Link href="/api/auth/logout">
          <a>Logout</a>
        </Link>
      </p>
    </div>
  )
}

export const getServerSideProps = withPageAuthRequired()

export default Index
```

> 注意：`withPageAuthRequired`は、ユーザーが現在ログインしていない場合、自動的に`/api/auth/login`にリダイレクトします。

これが機能しているかどうかを確認するには、`http://localhost:3000`に移動して、Auth0のサインイン画面にリダイレクトしてください。

![Auth0 sign in screen](/img/guides/integrations/auth0/xLRL7S7.png)

新しいアカウントで`サインアップする`か、`Continue with Google`をクリックしてサインインしてください。

これでランディングページを見ることができるはずです。

![Landing page](/img/guides/integrations/auth0/YdBKRy6.png)

## ステップ6: Supabase用のAuth0トークンの登録

現在のところ、SupabaseとAuth0のどちらも、JWTにカスタムの署名秘密を設定できません。また、異なる[署名アルゴリズム](https://auth0.com/docs/configure/applications/signing-algorithms)を使用しています。

そのため、Auth0のJWTから必要なビットを抽出し、自分で署名してSupabaseに送信する必要があります。

これには、Auth0の`afterCallback`関数を使用します。

`jsonwebtoken`ライブラリをインストールします。

```bash
npm i jsonwebtoken
```

`pages/api/auth/[...auth0].js`を以下のように更新します。

```jsx
// pages/api/auth/[...auth0].js

import { handleAuth, handleCallback } from '@auth0/nextjs-auth0'
import jwt from 'jsonwebtoken'

const afterCallback = async (req, res, session) => {
  const payload = {
    userId: session.user.sub,
    exp: Math.floor(Date.now() / 1000) + 60 * 60,
  }

  session.user.accessToken = jwt.sign(payload, process.env.SUPABASE_SIGNING_SECRET)

  return session
}

export default handleAuth({
  async callback(req, res) {
    try {
      await handleCallback(req, res, { afterCallback })
    } catch (error) {
      res.status(error.status || 500).end(error.message)
    }
  },
})
```

JWTの`ペイロード`には、Auth0 -`session.user.sub`のユーザーの一意の識別子と、1時間の有効期限が含まれます。

Supabaseの署名秘密を使ってこのJWTに署名します。

> 注：`afterCallback`関数を実行し、新しいトークンを作成するために、ユーザーを一旦サインアウトし、再度サインインする必要があります。

あとは、このトークンをSupabaseにリクエストと一緒に送信するだけです。

## ステップ7： Supabaseへのデータ要求

`utils/supabase.js`という新しいファイルを作成し、以下の内容を追加します。

```jsx
// utils/supabase.js

import { createClient } from '@supabase/supabase-js'

const getSupabase = (access_token) => {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL,
    process.env.NEXT_PUBLIC_SUPABASE_KEY
  )

  if (access_token) {
    supabase.auth.session = () => ({
      access_token,
    })
  }

  return supabase
}

export { getSupabase }
```

これは、Supabaseと会話するためのクライアントになります。これに`アクセストークン`を渡せば、リクエストに添付されます。

Supabaseから`Todos`をランディングページに読み込んでみましょう。

```jsx
// pages/index.js

import styles from '../styles/Home.module.css'
import { withPageAuthRequired } from '@auth0/nextjs-auth0'
import { getSupabase } from '../utils/supabase'
import Link from 'next/link'
import { useEffect } from 'react'

const Index = ({ user }) => {
  const [todos, setTodos] = useState([])
  const supabase = getSupabase(user.accessToken)

  useEffect(() => {
    const fetchTodos = async () => {
      const { data } = await supabase.from('todo').select('*')
      setTodos(data)
    }

    fetchTodos()
  }, [])

  return (
    <div className={styles.container}>
      <p>
        Welcome {user.name}!{' '}
        <Link href="/api/auth/logout">
          <a>Logout</a>
        </Link>
      </p>
      {todos?.length > 0 ? (
        todos.map((todo) => <p key={todo.id}>{todo.content}</p>)
      ) : (
        <p>You have completed all todos!</p>
      )}
    </div>
  )
}

export const getServerSideProps = withPageAuthRequired()

export default Index
```

あるいは、`getServerSideProps`関数を使ってサーバー上のTodosを取得もできます。

```jsx
// pages/index.js

import styles from '../styles/Home.module.css'
import { withPageAuthRequired, getSession } from '@auth0/nextjs-auth0'
import { getSupabase } from '../utils/supabase'
import Link from 'next/link'

const Index = ({ user, todos }) => {
  return (
    <div className={styles.container}>
      <p>
        Welcome {user.name}!{' '}
        <Link href="/api/auth/logout">
          <a>Logout</a>
        </Link>
      </p>
      {todos?.length > 0 ? (
        todos.map((todo) => <p key={todo.id}>{todo.content}</p>)
      ) : (
        <p>You have completed all todos!</p>
      )}
    </div>
  )
}

export const getServerSideProps = withPageAuthRequired({
  async getServerSideProps({ req, res }) {
    const {
      user: { accessToken },
    } = await getSession(req, res)

    const supabase = getSupabase(accessToken)

    const { data: todos } = await supabase.from('todo').select('*')

    return {
      props: { todos },
    }
  },
})

export default Index
```

どちらにしても、アプリケーションをリロードすると、TODOの状態が空になっています。

![Empty todo list](/img/guides/integrations/auth0/XgEMwnN.png)

これは、デフォルトですべてのリクエストをブロックする行単位セキュリティー を有効にしたためです。ユーザーが`Todos`を選択できるようにするには、ポリシーを書く必要があります。

## ステップ8: 選択を許可するためのポリシーを書く

ポリシーには、現在ログインしているユーザーが誰であるかを知り、そのユーザーにアクセス権を与えるかどうかを決定する必要があります。新しいJWTから現在のユーザーを抽出するために、PostgreSQLの関数を作りましょう。

Supabaseダッシュボードに戻り、サイドバーメニューから`SQL`を選択し、`New query` をクリックします。これにより、`new sql snippet`という新しいクエリが作成され、Postgresデータベースに対して任意のSQLを実行できるようになります。

以下のように記述し、`「Run」`をクリックします。

```sql
create or replace function auth.user_id() returns text as $$
  select nullif(current_setting('request.jwt.claim.userId', true), '')::text;
$$ language sql stable;
```

これにより、`auth.user_id()`という関数が作成され、JWTペイロードの`userId`フィールドを検査できます。

> 注：PostgreSQLの関数について詳しく知りたい方は、こちら[のビデオ](https://www.youtube.com/watch?v=MJZCCpCYEqk)をご覧ください。

このユーザーがTodoの所有者であるかどうかをチェックするポリシーを作成しましょう。

Supabaseのサイドバー メニューから`[Authentication]`を選択し、`[Policies]` をクリックして、`Todo`テーブルの`[New Policy`]をクリックします。

![Create new policy](/img/guides/integrations/auth0/M7XyhHe.png)

モーダルから`Create a policy from scratch`を選択し、以下を追加します。

![Policy settings for SELECT](/img/guides/integrations/auth0/wuWz3am.png)

このポリシーは、先ほど作成した関数を呼び出して、現在ログインしているユーザーのID`auth.user_id()`を取得し、これが現在の`Todo`の`user_id`列と一致するかどうかをチェックしています。一致した場合はユーザーの選択を許可し、一致しない場合は拒否し続けます。

`Review」`をクリックし、`「Save policy」`をクリックします。

> 注：RLSとポリシーの詳細については、[ディープダイブビデオ](https://www.youtube.com/watch?v=Ow_Uzedfohk)をご覧ください。

最後にやるべきことは、既存の`TODO`の`user_id`列を更新することです。

Supabaseのダッシュボードに戻って、サイドバーから`Table editor`を選択します。

![User ID null in Supabase Table Editor](/img/guides/integrations/auth0/dLOvhdq.png)

`user_id`列がすべて`NULL`になっています。

Auth0ユーザーのIDを取得するには、Auth0ダッシュボードに移動します。サイドバーから`「ユーザー管理」`を選択し、`「ユーザー」`をクリックして、テストユーザーを選択します。

![List of users in Auth0 dashboard](/img/guides/integrations/auth0/GdXS013.png)

そのユーザーの`user_id`をコピーします。

![User ID in Auth0 dashboard](/img/guides/integrations/auth0/tbvd0Uj.png)

Supabaseの各行を更新します。

![User ID set to Auth0 user](/img/guides/integrations/auth0/tPu4Tt8.png)

これで、アプリケーションを更新すると、ようやく`TODO`のリストが表示されるはずです。

> Note: Supabaseに新しい`Todos`を書き込む例はこちら[の](https://github.com/dijonmusters/supabase-auth0-example/blob/main/pages/index.js)リポジトリをご覧ください。

## リソース

- [Auth](https://auth0.com/)0の公式サイト
- [Auth0のブログ](https://auth0.com/blog/)
- [Using Next.js and Auth0 with Supabase の記事](https://auth0.com/blog/using-nextjs-and-auth0-with-supabase/)を参照
- [Auth0 コミュニティ](https://community.auth0.com/)
- Auth0の[ドキュメント](https://auth0.com/docs/)
