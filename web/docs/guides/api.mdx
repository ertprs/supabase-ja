---
id: api
title: API
description: APIの自動生成とリアルタイムAPI
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## 概要

Supabaseはデータベースのスキーマから直接3つのタイプのAPIを生成します。

- REST - レストフルなインターフェースでやりとりします。
- Realtime - データベースの更新をリッスンします。
- GraphQL - [まもなく公開](https://supabase.com/blog/2021/12/03/pg-graphql)です。

これらのAPIは次の特徴があります。

- 即時性と自動生成：データベースを更新すると、その変更内容がAPIを通じてすぐアクセス可能になります。
- ドキュメントの生成：Supabaseは、データベースを変更した際、ダッシュボードに更新されたドキュメントを生成します。
- セキュア：APIはPostgreSQLの行単位セキュリティーと連動するように設定されており、APIゲートウェイの背後でキーによる認証が有効になっています。
- 高速： 基本的な読み込みのベンチマークでは、Firebaseと比較して300%以上の高速化を実現しています。APIはPostgres上の非常に薄い層であり、Postgresがほとんどの力仕事をします。
- スケーラブル：APIは数千の同時リクエストに対応しており、サーバレスの処理にも適しています。


### RESTful API

Supabaseは、[PostgREST](https://postgrest.org/)を用いたRESTfulなAPIを提供しています。これは、Postgresの上の非常に薄いAPI層です。
これは、CRUDのAPIに必要なすべてを提供します。

- 基本的なCRUD操作
- 深くネストされた結合により、1回のフェッチで複数のテーブルからデータを取得可能
- Potgresのビューと連動
- Postgresの関数と連動
- 行単位セキュリティー、ロール、およびGRANTなどの、Postgresのセキュリティモデルと連動

<iframe
  className="w-full video-with-border"
  width="640"
  height="480"
  src="https://www.youtube-nocookie.com/embed/rPAJJFdtPw0"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

### リアルタイムAPI

Supabaseは[Realtime](https://github.com/supabase/realtime)を使って、リアルタイムAPIを提供しています。これを利用して、データベースの変更をWebSocketで待ち受けることができます。
RealtimeはPostgreSQLに組み込まれた論理的なレプリケーションを利用しています。Postgresのパブリケーションを管理するだけで、リアルタイムAPIを管できますす。

### GraphQL API

[Coming soon](https://supabase.com/blog/2021/12/03/pg-graphql). We are developing `pg_graphql`, an open source PostgreSQL extension for GraphQL. 
`pg_graphql` inspects an existing PostgreSQL schema and reflects a GraphQL schema with resolvers. We will expose `pg_graphql` via the existing REST interface.


## はじめに

テーブルや関数をデータベースに追加した後、APIを利用できます。

### APIルートの作成

APIルートは、Postgresのテーブル、ビュー、または関数を作成する際、自動的に作成されます。

最初のAPIルートを作成するために、`todos`というテーブル（いくつかユーザーのパブリックな情報を保存します）を作成しましょう。
これにより、`GET`、`POST`、`PATCH`、`DELETE`のリクエストを受け付けることができる、`todos`に対応したルートが作成されます。

<!-- textlint-disable -->

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

<!-- textlint-enable -->

```sh
1. 「Table Editor」セクションに移動します。
2. 「New Table」をクリックします。
3. 「todos」というテーブル名を入力します。
4. 「Save」をクリックします。
5. 「New Column」をクリックします。
6. 「task」というカラム名を入力し、タイプを「text」にします。
7. 「Sava」をクリックします。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-create-table-sm.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="SQL">

```sql
-- タスクを格納する列を持つ「todos」というテーブルを作成します。

create table todos (
  id bigint generated by default as identity primary key,
  task text check (char_length(task) > 3)
);
```

</TabItem>
</Tabs>


### API URLとキー

Supabaseの各プロジェクトには、固有のAPI URLがあります。APIはAPIゲートウェイで保護されており、リクエストごとにAPIキーが必要となります。

キーはダッシュボードで探すことができます。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'}
]}>
<TabItem value="UI">

```sh
1. 「Settings」セクションに移動します。
2. サイドバーの「API」をクリックします。
3. そのページ内で、API URLを探します。
4. そのページ内で、「anon」と「service_role」キーを探します。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-url-and-key.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
</Tabs>


#### 詳細とリンク集

最初は2つのキーが用意されています。

- `anon`キーはブラウザのコンテキストで使用しても安全です。
- `service_role`キーはサーバー上でのみ使用します。このキーは行単位セキュリティーを回避できます。


### ドキュメントへのアクセス

Supabaseは、データベースの変更に応じてドキュメントを更新して、ダッシュボードに生成します。

最初のステップで作成した`todos`テーブルのドキュメントを見てみましょう。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'}
]}>
<TabItem value="UI">

```sh
1. 「API」セクションに移動します。
2. 「Tables and views」セクションで「todos」を探します。
3. タブを使用して、JavascriptとcURLのドキュメントを切り替えます。
```

</TabItem>
</Tabs>


### APIの利用

HTTPリクエストを介してAPIを直接操作できますし、当社が提供するクライアント・ライブラリーを使用できます。

<!-- textlint-disable ja-technical-writing/sentence-length -->
それでは、最初のステップで作成した`todos`テーブルに、取得したAPI URL（`[SUPABASE_URL]`）とキー（`[SUPABASE_ANON_KEY]`）を使ってリクエストする方法を見てみましょう。
<!-- textlint-enable ja-technical-writing/sentence-length -->

<!-- textlint-disable -->

<Tabs
defaultValue="Javascript"
values={[
  {label: 'Javascript', value: 'Javascript'},
  {label: 'cURL', value: 'cURL'},
]}>
<TabItem value="Javascript">

<!-- textlint-enable -->

```javascript
// JSクライアントを初期化
import { createClient } from '@supabase/supabase-js'
const supabase = createClient([SUPABASE_URL], [SUPABASE_ANON_KEY])

// リクエストを作成
let { data: todos, error } = await supabase
  .from('todos')
  .select('*')
```

</TabItem>
<TabItem value="cURL">

```bash
# URLに/rest/v1/を追加して、テーブル名をルートとして使用
curl '[SUPABASE_URL]/rest/v1/todos' \
-H "apikey: [SUPABASE_ANON_KEY]" \
-H "Authorization: Bearer SUPABASE_ANON_KEY"
```

</TabItem>
</Tabs>

#### 詳細とリンク集

- Postgresでテーブルを作成すると、デフォルトでは行単位セキュリティー（RLS）が無効になっています。[RLSを有効にする](/docs/guides/api#securing-your-routes)ことでセキュリティーを確保してください。
- `service_role`キーをブラウザやユーザーが見られる場所にさらさないでください。
<!-- textlint-disable ja-technical-writing/max-comma -->
- JSリファレンス：[select()](/docs/reference/javascript/select),
[insert()](/docs/reference/javascript/insert),
[update()](/docs/reference/javascript/update),
[upsert()](/docs/reference/javascript/upsert),
[delete()](/docs/reference/javascript/delete),
[rpc()](/docs/reference/javascript/rpc)（Postgresの関数呼び出し）
<!-- textlint-enable ja-technical-writing/max-comma -->

### リアルタイムの管理


リアルタイムAPIは、PostgreSQLのレプリケーション機能を介して動作します。Postgresはデータベースの変更を、`supabase_realtime`と呼ばれる「パブリケーション」に送信します。
このパブリケーションを管理することで、どのデータをブロードキャストするかを制御できますす。

デフォルトでは、データベースのリアルタイムは無効になっています。それでは、`todos`テーブルのリアルタイムを有効にしてみましょう。

<!-- textlint-disable -->

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

<!-- textlint-enable -->

```sh
1. 「Database」セクションに移動します。
2. サイドバーの「Replication」をクリックします。
3. Insert/Update/Deleteのトグルを切り替えることで、どのデータベース・イベントを送信するか制御します。
4. 「Source」をクリックしてテーブルを切り替えることで、どのテーブルの変更を反映するか制御できます。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-realtime.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="SQL">

```sql
alter publication supabase_realtime add table products;
```

</TabItem>
</Tabs>

#### 詳細とリンク集

- リアルタイムを有効にするのは、パブリックテーブル（すべてのデータにアクセスできる必要がある）のみです。
- [JSリファレンス](/docs/reference/javascript/subscribe)：リアルタイム・クライアントを使ってデータベースの変更を受信します。


### ルートのセキュア化

<!-- textlint-disable -->

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

<!-- textlint-enable -->

```sh
1. 「Authentication」セクションに移動します。
2. サイドバーの「Policies」をクリックします。
3. 南京錠をクリックして、行単位セキュリティーを有効にします。
```

</TabItem>
<TabItem value="SQL">

```sql
alter table todos enable row level security;
```

</TabItem>
</Tabs>


#### 詳細とリンク集

- APIは、Postgresの行単位セキュリティーと連動するように設計されています。Supabaseの[認証](/docs/guides/auth)を使用すれば、ログインしたユーザーに基づいてデータを制限できます。
- データへのアクセスを制御するには、[ポリシー](/docs/guides/auth#policies)を使用します。
